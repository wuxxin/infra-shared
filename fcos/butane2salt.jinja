{# translates and inlines a subset of butane spec into a one file saltstack salt spec

to be used from the systemd service "coreos-update-config.service"
in a saltstack salt-call command, which updates the config to the desired state
keeps changes minimal, smart restarts of direct or indirectly changed services

#### Translation

- Only the currently used subset in *.bu files of the butane spec is supported
  - only storage:directories/links/files/trees and systemd:units[:dropins] are translated
  - Filenames /etc/hosts, /etc/hostname, /etc/resolv.conf are translated to /host_etc/*

- Look at tools.jinja_run for custom filter like traverse files or regex_replace
- use 'import "subdir/filename" as contents' to import from basedir/subdir/filename

#### additional outputs if {UPDATE_SERVICE_STATUS} == true

- creates a commented, non uniqe, not sorted list of service base names
  - {UPDATE_DIR}/service_changed.txt for changed configuration
  - {UPDATE_DIR}/service_enabled.txt for services to be enabled
  - {UPDATE_DIR}/service_disabled.txt for services to be disabled

- usage example:
  - cat ${UPDATE_DIR}/service_changed.txt | grep -v "^#" | grep -v "^[[:space:]]*$" | sort | uniq

#}
{% set UPDATE_DIR= "/run/user/1000/coreos-update-config" %}
{% set UPDATE_SERVICE_STATUS=UPDATE_SERVICE_STATUS|d(true)%}
{#

write out user,group,mode if present

#}
{%- macro user_group_mode(o) -%}
{%- if o.user is defined -%}
{%- if o.user.id is defined   %}    - user: {{ o.user.id }}{% endif %}
{%- if o.user.name is defined %}    - user: {{ o.user.name }}{% endif %}
{%- endif -%}
{%- if o.group is defined -%}
{%- if o.group.id is defined   %}    - group: {{ o.group.id }}{% endif %}
{%- if o.group.name is defined %}    - group: {{ o.group.name }}{% endif %}
{%- endif -%}
{%- if o.mode is defined %}    - mode: {{ "%#o"|format(o.mode) }}{% endif %}
{%- endmacro -%}
{#

replace filename with /host_etc prefix if in /etc/hostname, /etc/hosts, /etc/resolv.conf

#}
{% macro tr_etc(f) %}{% if f in ["/etc/hostname","/etc/hosts","/etc/resolv.conf"] %}{% set f=f|replace("/etc", "/host_etc") %}{% endif %}{{ f }}{% endmacro %}
{#

create service change/enable/disable macros and accumulator targets

#}
{% if UPDATE_SERVICE_STATUS %}
{#

write service to service_enabled/disabled.txt

#}
{%- macro service_status(service_path, service_name, enabled) -%}
{%- set status="enabled" if enabled else "disabled" %}

service_{{ status }}_{{ service_path }}:
  file.accumulated:
    - filename: {{ UPDATE_DIR }}/service_{{ status }}.txt
    - text: {{ service_name }}
    - require_in:
      - file: service_{{ status }}

{%- endmacro -%}
{% macro service_enabled(p, n) %}{{ service_status(p, n, true) }}{% endmacro %}
{% macro service_disabled(p, n) %}{{ service_status(p, n, false) }}{% endmacro %}
{#

write service to service_changed.txt if target changed

#}
{%- macro service_changed(service, target, target_type) -%}

service_changed_{{ target }}:
  file.accumulated:
    - filename: {{ UPDATE_DIR }}/service_changed.txt
    - text: {{ service }}
    - onchanges:
      - {{ target_type }}: {{ target }}
    - require_in:
      - file: service_changed

{%- endmacro -%}
{#

if target matches regex_list , call service_changed(service, target)

regex_list:
  - any unit in systemd/system/*.*
  - any dropin in systemd/system/*.d/*.conf
  - any env in [local,containers,compose]/*.env
  - any file in [containers,compose]/build/*/*

#}
{%- macro target_changed(target, target_type="file") -%}
  {%- set service_regex_list = [
    "/etc/systemd/system/([^/]+)\.[^\.]+",
    "/etc/systemd/system/([^/]+)\.[^\.]+\.d/.+\.conf",

    "/etc/local/environment/([^/]+)\.env",
    "/etc/containers/environment/([^/]+)\.env",
    "/etc/compose/environment/([^/]+)\.env",

    "/etc/containers/systemd/([^/.]+)\..+",

    "/etc/containers/build/([^/]+)/.+",
    "/etc/compose/build/([^/]+)/.+",
  ] -%}
  {%- set target_ns= namespace(service_name="") -%}
  {%- for service_regex in service_regex_list -%}
    {%- if target|regex_match("^" ~ service_regex~ "$") -%}
      {%- set target_ns.service_name = target|regex_replace(service_regex, '\\1') -%}
    {%- endif -%}
  {%- endfor -%}
  {%- if target_ns.service_name != "" -%}
{{ service_changed(target_ns.service_name, target, target_type) }}
  {%- endif -%}
{%- endmacro -%}
{#

Accumulator targets for service_ enabled, disabled, changed

#}
  {% for s in ["enabled", "disabled", "changed"] %}
create_service_{{ s }}:
  file.managed:
    - name: {{ UPDATE_DIR }}/service_{{ s }}.txt
    - user: 1000
    - group: 1000

service_{{ s }}:
  file.blockreplace:
    - name: {{ UPDATE_DIR }}/service_{{ s }}.txt
    - marker_start: "# START"
    - marker_end: "# END"
    - content: ""
    - append_if_not_found: True
    - show_changes: True
    - require:
      - file: create_service_{{ s }}
  {% endfor %}

{% else %}
{#

mask service change/enable/disable macros

#}
{%- macro service_status(service_path, service_name, enabled) -%}
{%- endmacro -%}
{%- macro service_enabled(service_path, service_name) -%}
{%- endmacro -%}
{%- macro service_disabled(service_path, service_name) -%}
{%- endmacro -%}
{%- macro service_changed(service, target, target_type) -%}
{%- endmacro -%}
{%- macro target_changed(target, target_type="file") -%}
{%- endmacro -%}

{% endif %}
{#

Main Translation of storage:directories, links, files, trees, systemd units and dropins

#}
{%- if "storage" in butane and "directories" in butane.storage %}
  {%- for d in butane.storage.directories %}
{{ d.path }}:
  file.directory:
    - makedirs: true
{{ user_group_mode(d) }}
  {% endfor %}
{%- endif %}


{%- if "storage" in butane and "links" in butane.storage %}
  {%- for l in butane.storage.links %}
{{ l.path }}:
  file.symlink:
    - makedirs: True
    {%- if l.target is defined %}
    - target: {{ l.target }}
    {%- endif %}
    {%- if l.hard is defined and l.hard %}
    - hard: true
    {%- endif %}
{{ user_group_mode(l) }}
{{ target_changed(l.path) }}
  {% endfor %}
{%- endif %}


{%- if "storage" in butane and "files" in butane.storage %}
  {%- for f in butane.storage.files %}
    {%- set target_type="file" %}
{{ tr_etc(f.path) }}:
  file.managed:
    - makedirs: True
{{ user_group_mode(f) }}
    {%- if f.contents is defined %}
      {%- if f.contents.source is defined %}
        {%- if f.contents.source.startswith("data:") %}
          {%- set target_type="cmd" %}
  cmd.run:
    - name: |
        cat <<"EOF" | base64 -d > {{ tr_etc(f.path) }}
        {{ f.contents.source|indent(8) }}
        EOF
    - onlyif: base64 -d < {{ tr_etc(f.path) }} | cmp -s - /dev/stdin
    - creates: {{ tr_etc(f.path) }}
        {%- else %}
    - source: {{ f.contents.source }}
        {%- endif %}
      {%- endif %}
      {%- if f.verification is defined %}
    - source_hash: {{ f.verification[7:] }}
      {%- endif %}
      {%- if f.contents.inline is defined %}
    - contents: |
        {{ f.contents.inline|indent(8) }}

      {%- endif %}
      {%- if f.contents.local is defined %}
        {%- import f.contents.local as contents %}
    - contents: |
        {{ contents|string()|indent(8) }}

      {%- endif %}
    {%- endif %}
{{ target_changed(tr_etc(f.path), target_type) }}
  {% endfor %}
{%- endif %}


{%- if "storage" in butane and "trees" in butane.storage %}
  {%- for t in butane.storage.trees %}
    {%- set path = t.path %}
    {% set list_str= t.local|list_files() %}
    {%- for f in list_str.split("\n") %}
      {%- import f as contents %}
      {%- set fp= path ~ '/'~ f.replace(t.local ~ '/', '') %}
{{ tr_etc(fp) }}:
  file.managed:
    - makedirs: True
    - contents: |
        {{ contents|string()|indent(8) }}

{{ target_changed(tr_etc(fp)) }}
    {% endfor %}
  {% endfor %}
{%- endif %}


{%- if "systemd" in butane and "units" in butane.systemd %}
  {%- for u in butane.systemd.units %}
    {%- set up= "/etc/systemd/system/" ~ u.name %}
    {%- if u.enabled is defined %}
{{ service_status(up, u.name, u.enabled) }}
    {%- endif %}
    {%- if not u.mask|d(false) %}
      {%- if u.contents is defined or u.contents_local is defined %}
{{ up }}:
  file.managed:
    # XXX do not follow_symlinks, because if masked file is symlinked to /dev/null
    - follow_symlinks: False
        {%- if u.contents is defined %}
    - contents: |
        {{ u.contents|indent(8) }}

        {%- elif u.contents_local is defined %}
          {%- import u.contents_local as contents %}
    - contents: |
        {{ contents|string()|indent(8) }}

        {%- endif %}
{{ target_changed(up) }}
      {%- endif %}
    {%- else %}
{{ up }}:
  file.symlink:
    # XXX force to replace a normal file, because if real file exists beforehand
    - force: True
    - target: /dev/null
{{ target_changed(up) }}
    {%- endif %}

    {%- if u.dropins is defined %}
      {%- for d in u.dropins %}
        {%- set dp="/etc/systemd/system/" ~ u.name ~ ".d/" ~ d.name %}
{{ dp }}:
  file.managed:
    - makedirs: True
        {%- if d.contents is defined %}
    - contents: |
        {{ d.contents|indent(8) }}

        {%- endif %}
        {%- if d.contents_local is defined %}
          {%- import d.contents_local as contents %}
    - contents: |
        {{ contents|string()|indent(8) }}

        {%- endif %}
{{ target_changed(dp) }}
      {% endfor %}
    {%- endif %}
  {% endfor %}
{%- endif %}
